# Kinesis LND Engine

<img src="https://kines.is/logo.png" alt="Kinesis Exchange" width="550">

[![CircleCI](https://circleci.com/gh/kinesis-exchange/lnd-engine.svg?style=svg&circle-token=47c81b3a717f062885f159dfded078e134413db1)](https://circleci.com/gh/kinesis-exchange/lnd-engine)

The following repo contains 2 modules that make up a `Kinesis Engine`:

1. NPM module w/ LND abstraction layer (located in `src`)
2. Dockerfiles for all containers needed for the LND Engine to work correctly

Our current docker setup consists of the following containers:

- roasbeef/BTCD - Headless daemon to interact with blockchain (no wallet in this package)
- LND - Lightning Network Daemon + Wallet
- repl - an interactive shell for using the lnd-engine stack

#### Getting Started

```
npm i
npm run build
npm test
```

You can access the repl through `docker-compose run repl npm run c` and view all available commands with `commands`

#### Installation via NPM

You must have ssh/private access to the lnd-engine to be able to download these files. Add the following reference to your `package.json`:

```
{
  "dependencies": {
    ...
    "lnd-engine": "kinesis-exchange/lnd-engine"
  }
}
```

Then add the following commands to your `package.json`:

```
    "lup": "npm explore lnd-engine -- docker-compose -p $npm_package_config_project_name up -d",
    "ld": "npm explore lnd-engine -- docker-compose -p $npm_package_config_project_name down -v",
    "lps": "npm explore lnd-engine -- docker-compose -p $npm_package_config_project_name ps"
```

NOTE: If you are trying to use `lnd-engine` locally, you may need to blow away your projects `npm-shrinkwrap` file to avoid caching of the incorrect repo.


### IMPORTANT ABOUT SSL:

- Node GRPC does not support the same certs that are generated by LND, so we have to modify the lnd_btc.sh script to accomadate this
- lnd_btc needs to listen on port `0.0.0.0` for RPC or is will never reach out of the docker container
- There are GRPC_SSL_CIPHER lists that need to be updated for grpc to recongnize the certs used by LND#

```
Beware that lnd autogenerated certificates are not compatible with current NodeJS gRPC module implementation.

Lnd uses the P-521 curve for its certificates but NodeJS gRPC module is only compatible with certificates using the P-256 curve (link).

You need to generate your own lnd certificates using the following commands (thanks to Alex Akselrod for helping me on this):

# Enter the Lnd home directory, located by default at ~/.lnd on Linux or
# /Users/[username]/Library/Application Support/Lnd/ on Mac OSX
# $APPDATA/Local/Lnd on Windows. Also change '/CN=localhost/O=lnd' to '//CN=localhost\O=lnd' if you are using Git Bash.
cd ~/.lnd
openssl ecparam -genkey -name prime256v1 -out tls.key
openssl req -new -sha256 -key tls.key -out csr.csr -subj '/CN=localhost/O=lnd'
openssl req -x509 -sha256 -days 36500 -key tls.key -in csr.csr -out tls.cert
rm csr.csr
```

More Info: [lncli issue](https://github.com/mably/lncli-web/issues/121) && [cipher](https://github.com/lightningnetwork/lnd/issues/861#issuecomment-373811976)

### Troubleshooting SSL

Using `GRPC_VERBOSITY=DEBUG` and `GRPC_TRACE=all` on the relayer is our best friend

You can dive into the connections inside of a container w/ the following commands:

```
openssl s_client -connect lnd_btc:10009 -prexit

apt-get update && apt-get install tcpdump
tcpdump port 10009 and '(tcp-syn|tcp-ack)!=0'

curl --cacert /secure/tls.cert https://lnd_btc:10009 -v
```

