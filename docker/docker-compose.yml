version: '3'

################################################################################
#
# NOTE: This docker-compose only contains LND setup for BTC. LTC and other coins
# are not currently implemented for the kinesis exchange
#
# The official LND docker setup can be found here:
# https://github.com/lightningnetwork/lnd/tree/master/docker
#
################################################################################

services:
  repl:
    image: node:8
    working_dir: '/home/app'
    volumes:
      - '../:/home/app'
      - 'secure:/secure/'
    environment:
      # - GRPC_VERBOSITY=INFO
      # - GRPC_TRACE=all
      - NODE_PATH=.
      - LND_HOST=lnd_btc:10009
      - TLS_CERT_PATH=/secure/tls.cert
      - MACAROON_PATH=/secure/admin.macaroon
      - GRPC_SSL_CIPHER_SUITES=HIGH+ECDSA
    networks:
      - lnd

  btcd:
    build:
      context: ./
      dockerfile: btcd/Dockerfile
    volumes:
      - shared:/rpc
      - bitcoin:/data
    environment:
      - RPC_USER=kuser
      - RPC_PASS=kpass
      - NETWORK=simnet
      - DEBUG=info
      - DATA_DIR=/data
      - LOG_DIR=/data
      - RPC_KEY=/rpc/rpc.key
      - RPC_CERT=/rpc/rpc.cert
      - RPC_LISTEN=0.0.0.0
      # This is set dynamically in the startup scripts
      # TODO: figure out how to dynamically set this variable and prevent it from
      # triggering warnings
      - "MINING_ADDRESS=$MINING_ADDRESS"
    expose:
      - '8333' # mainnet p2p
      - '8444' # mainnet rpc
      - '18333' # testnet p2p
      - '18334' # testnet rpc
      - '18555' # simnet p2p
      - '18556' # simnet rpc
      - '28901' # segnet p2p
      - '28902' # segnet rpc
    networks:
      lnd:
        aliases:
          - blockchain
          - rpcserver
    entrypoint: ["./start-btcd.sh"]

  lnd_btc:
    build:
      context: ./
      dockerfile: lnd/Dockerfile
    environment:
      - RPC_USER=kuser
      - RPC_PASS=kpass
      - RPC_HOST=blockchain
      - RPC_CERT_PATH=/rpc/rpc.cert
      - ADMIN_MACAROON=/secure/admin.macaroon
      - READ_ONLY_MACAROON=/secure/readonly.macaroon
      - TLS_CERT_PATH=/secure/tls.cert
      - TLS_KEY_PATH=/secure/tls.key
      - NETWORK=simnet
      - CHAIN=bitcoin
      - DEBUG=info
      - RPC_LISTEN=0.0.0.0:10009
      - LISTEN=0.0.0.0:10111
      - REST_LISTEN=0.0.0.0:8101
      - DATA_DIR=/data
      - LOG_DIR=/data
      - NODE=btcd
      - SECURE_DIRECTORY=/secure
    networks:
      - lnd
    volumes:
      - 'shared:/rpc'
      - 'secure:/secure/'
      - 'lnd:/data'
    expose:
      - '10009'
      - '10111'
      - '8101'
    entrypoint: ["./start-lnd.sh"]

volumes:
  secure:
  shared:
  bitcoin:
  lnd:

networks:
  lnd:
